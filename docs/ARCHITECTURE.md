# Архитектура приложения Strategic Analyst AI

## Назначение

Веб-приложение на Streamlit для **стратегических сессий**: участники по QR-коду заходят с телефонов или ноутбуков и в live-режиме оценивают предложения с помощью нейросети. Режимы: консультант (диалог с AI) и SWOT-анализ (массовая оценка тезисов с выгрузкой в Excel и Word). Ответы нейросети настраиваются как **короткие** (несколько строчек), чтобы их было удобно читать и оперативно собирать в онлайне.

## Структура проекта

```
strategicanalystai/
├── app.py                    # Точка входа: конфиг страницы, инициализация, сборка UI
├── core/                     # Конфигурация и состояние
│   ├── config.py             # Константы: модели, лимиты, типы файлов
│   └── state.py              # Инициализация session_state
├── ui/                       # Компоненты интерфейса
│   ├── styles.py             # Подключение кастомного CSS
│   ├── header.py             # Верхняя панель (логотип, статус API)
│   ├── sidebar.py            # Боковая панель: API, модель, подсказки
│   ├── consultant_tab.py     # Режим «Консультант»: чат, файл, экспорт
│   └── swot_tab.py           # Режим «SWOT-Анализ»: ввод, анализ, таблица, экспорт
├── services/                 # Бизнес-логика, не зависящая от Streamlit
│   ├── file_parser.py        # Парсинг тезисов и чтение файлов в текст
│   └── swot_ui.py            # Вердикты, HTML-таблица результатов
├── modules/                  # Интеграции и экспорт
│   ├── api_handler.py        # Запросы к OpenRouter API
│   ├── prompts.py            # Системные промты для консультанта и SWOT
│   └── export_utils.py       # Экспорт в XLSX, CSV, MD, DOCX (чат и SWOT)
├── .streamlit/
│   ├── config.toml           # Тема и настройки Streamlit
│   └── styles.css            # Стили: кнопки, таблицы, бейджи, скроллбар
├── docs/
│   ├── ARCHITECTURE.md       # Этот файл
│   └── STRATEGIC_SESSION.md  # Сценарий сессии, live-сбор ответов, мобильная версия
├── requirements.txt
└── README.md
```

## Поток данных

1. **Запуск**  
   `app.py` задаёт `st.set_page_config`, вызывает `init_session_state()`, подключает CSS и рендерит header и sidebar. Sidebar возвращает `(api_key, model)` для использования в табах.

2. **Консультант**  
   Пользователь вводит сообщение (и опционально прикрепляет файл). Контекст файла читается через `services.file_parser.read_uploaded_file_as_text`. Сообщения хранятся в `st.session_state.chat_messages`. Ответ получается через `modules.api_handler.chat_completion_with_history`. Экспорт диалога — через `modules.export_utils` (TXT, MD, DOCX).

3. **SWOT-Анализ**  
   Тезисы вводятся текстом или загружаются файлом; парсинг — `services.file_parser.parse_theses_from_text` / `parse_theses_from_upload`. Для каждого тезиса вызывается `modules.api_handler.chat_completion`; ответ разбирается в `modules.export_utils.parse_swot_response`. Результаты в `st.session_state.swot_results`. Таблица строится в `services.swot_ui.build_results_table_html`. Экспорт — XLSX (с листом «Сводка»), DOCX, CSV, MD.

## Зависимости между слоями

- **app.py** зависит от: `core`, `ui`.
- **ui/** зависит от: `core`, `modules`, `services`.
- **services/** не зависит от `ui` и `app`; при необходимости использует только стандартные библиотеки и pandas.
- **modules/** — интеграции (API, промты, экспорт); не зависят от `ui` и `services`.

## Стили и кнопки

- Все тексты кнопок — только текст (без эмодзи/иконок в подписи), чтобы избежать отображения «keyboard_double_arrow» или других глифов при отсутствии шрифта.
- Цвета и типографика заданы в `.streamlit/styles.css` и `config.toml` (primary, фон, шрифт).

## Стратегическая сессия и устройства

- **Цель**: участникам выдаётся QR на сайт; они используют телефоны/ноутбуки во время сессии в live-режиме.
- **Промты**: настроены так, чтобы ответы были короткими (несколько строчек), а не длинными отчётами.
- **Мобильная версия**: в `.streamlit/styles.css` заданы `@media (max-width: 768px)` — компактные отступы, читаемый текст, удобные кнопки и поле ввода.
- **Live-сбор ответов**: текущая версия — каждый участник работает в своей сессии; экспорт (TXT, MD, XLSX, DOCX) позволяет собрать результаты. Варианты развития — в `docs/STRATEGIC_SESSION.md`.

## Продакшен

- Запуск: `streamlit run app.py` (корень проекта — рабочая директория).
- API-ключ не сохраняется между сессиями (только в `session_state`).
- Лимит размера загрузки задаётся в `.streamlit/config.toml` (например, 5 MB).
- Для сессии: развернуть приложение (Streamlit Cloud и т.п.), выдать участникам URL или QR на этот адрес.
